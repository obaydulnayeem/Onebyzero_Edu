{% extends "base.html" %}
{% load time_filters %}
{% load static %}

{% block title %}View Questions{% endblock %}
{% block content %}

    <div class="mt-2" style="margin-left: 30px; margin-right: -60px;">
       
        <div class="row">
            <div class="text-center">
                <h2>Questions of {{ course.title }}</h2>
                <p>
                    {% if course.department.system == 'year' %}
                        {{ course.year }} Year, 
                    {% else %}
                        {{ course.semester }} Semester, 
                    {% endif %}
                    Dept. of {{ course.department.name }},
                    {{ course.university.name }}</p>
            </div>

            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}

            <hr>

            <div class="col-md-7 resources-border">

                <form method="GET" class="mb-4">
                    <div class="row align-items-end">

                        {% comment %} EXAM FILTER {% endcomment %}
                        <div class="col-md-4 mb-2">
                            <label for="examFilter">Filter by Exam Name:</label>
                            <select name="exam_name" id="examFilter" class="form-control">
                                <option value="">All Exams</option>
                                <option value="1st Mid">1st Mid</option>
                                <option value="2nd Mid">2nd Mid</option>
                                <option value="3rd Mid">3rd Mid</option>
                                <option value="Class Test">Class Test</option>
                                <option value="Lab Test">Lab Test</option>
                                <option value="Lab Final">Lab Final</option>
                                <option value="Final">Final</option>
                                <!-- Add more options if needed -->
                            </select>
                        </div>

                        {% comment %} SESSION FILTER {% endcomment %}
                        <div class="col-md-4 mb-2">
                            <label for="sessionFilter">Filter by Session:</label>
                            <select name="session" id="sessionFilter" class="form-control">
                                <option value="">All Sessions</option>
                                <option value="24-25">24-25</option>
                                <option value="23-24">23-24</option>
                                <option value="22-23">22-23</option>
                                <option value="21-22">21-22</option>
                                <option value="20-21">20-21</option>
                                <option value="19-20">19-20</option>
                                <option value="18-19">18-19</option>
                            </select>
                        </div>

                        {% comment %} APPLY FILTER {% endcomment %}
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-secondary btn-block">Apply</button>
                        </div>

                    </div>
                </form>

                {% comment %} QUESTION CARDS {% endcomment %}
                <div class="row">
                    {% for qs in questions %}
                        <div class="col-md-4 mb-4">
                            <div class="card" style="background-color: #d7d8d9">
                                <div class="card-body" style="height: 235px; overflow: hidden;">

                                    <div  class="dropdown dropleft" style="position: absolute; top: 5px; right: 5px;">
                                        <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas"></i> <!-- Three-dot icon -->
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                            <li><a class="dropdown-item" href="#" onclick="generateShareLink('{{ qs.id }}')">Share Link</a></li>

                                            {% if user_profile.user_type == 'batch_ambassador' %}
                                            <li><a class="dropdown-item" href="{% url 'edit_question' qs.id %}">Edit</a></li>
                                            {% endif %}

                                            {% if user_profile.user_type == 'batch_ambassador' %}
                                            <li><a class="dropdown-item" href="{% url 'delete_question' qs.id %}"  onclick="return confirm('Are you sure you want to delete this question?')">Delete</a></li>
                                            {% endif %}
                                            

                                            <li><a class="dropdown-item" href="{% url 'submit_feedback' qs.id %}">Feedback/Report</a></li>

                                            {% comment %} <li><a class="dropdown-item" href="#">Something else here</a></li> {% endcomment %}
                                        </ul>
                                    </div>

                                        {% comment %} 
                                        <!-- Love reaction button -->
                                        <button class="btn btn-link" id="loveBtn{{ qs.id }}" onclick="handleLoveClick({{ qs.id }})">
                                            <i class="far fa-heart" id="loveIcon{{ qs.id }}"></i> 
                                            <span id="loveCount{{ qs.id }}">10</span> <!-- Counter for the love reaction -->
                                        </button> {% endcomment %}


                                                {% comment %} <!-- Love reaction button -->
                                        <button class="btn btn-link" id="loveBtn{{ qs.id }}" onclick="handleLoveClick({{ qs.id }})">
                                            <i class="far fa-heart" id="loveIcon{{ qs.id }}"></i>
                                            <span id="loveCount{{ qs.id }}">{{ qs.love_count }}</span> <!-- Counter for the love reaction -->
                                        </button> {% endcomment %}
                                    
                                        <p class="card-text">{% if qs.uploaded_by.profile_image %}<img src="{{ qs.uploaded_by.profile_image.url }}" alt="Profile Picture" style="width: 30px; height: 30px; object-fit: cover; border-radius: 50%;">{% else %} <i class="fas fa-user-circle" style="font-size: 24px;"></i>
                                            {% endif %}
                                        
                                                {% if qs.uploaded_by.nickname %}
                                                    {{ qs.uploaded_by.nickname }} <span style="opacity: 0.80">({{ qs.uploaded_by.departmental_batch}} batch)</span>
                                                {% else %}
                                                    {{ qs.uploaded_by.user }} ({{ qs.uploaded_by.departmental_batch}} batch)
                                                {% endif %}
                                            </p>

                                            <p style="margin-top: -20px; margin-left: 10px; opacity: 0.80">Uploaded {{ qs.upload_time|time_ago }} ago</p>
                                    {% comment %} <br/> {% endcomment %}

                                    <div class="text-center mb-2 pt-2 pb-1" style="background-color: #5e6266;">
                                        <h6 class="card-title" style="color: white">{{ qs.exam_name }} ({{ qs.session }})</h6>
                                    </div>

                                    
                                        
                                    

                                    {% comment %} <div class="text-center">
                                        <p><i class="fas fa-file-image" style="font-size: 50px; opacity: 0.25;"></i></p>
                                    </div> {% endcomment %}

                                    <br/>

                                    <div>
                                        <p class="card-text" style="text-align: center; margin-top: -35px"><i class="fas fa-user-graduate"></i>
                                            {{ qs.course_teacher }}</p>
                                    </div>

                                    <br/>

                                    <div class=""  style="opacity: 0.75;">
                                        {% if user.profile.is_verified %}
                                        <a href="{{ qs.question_file.url }}" target="_blank" class="btn btn-primary  view-btn" data-toggle="modal" data-target="#imageModal{{ qs.id }}">
                                            <i class="far fa-eye"></i>
                                        </a>


                                        {% else %}
                                        <a href="{% url 'need_verification' %}" class="btn btn-primary  view-btn" data-toggle="modal" data-target="#imageModal{{ qs.id }}">
                                            <i class="far fa-eye"></i> Not View
                                        </a>
                                        {% endif %}

                                        <button class="love-count-btn" id="loveBtn{{ qs.id }}" onclick="handleLoveClick({{ qs.id }})">{{ qs.love_count }}</button>
                                    </div>

                                    {% comment %} <a href="{% url 'delete_question' qs.id %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this question?')">
                                        <i class="far fa-trash-alt"></i> Delete
                                    </a> {% endcomment %}
                                    
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="col-12 text-center">No questions available.</p>
                        {% endfor %}
                    </div>
                    
            </div>

            <div style="width: 2%">
            </div>

            <div class="col-md-4 resources-border">
                <div class="row justify-content-between align-items-center mt-2">
                    <div>
                        <h6>Users who uploaded questions in this course:</h6>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    {% comment %} <th>Profile Picture</th> {% endcomment %}
                                    <th>Name</th>
                                    <th>Uploaded</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_info in users_with_question_count %}
                                    <tr>
                                        <td>
                                            {% comment %} {% if user_info.uploaded_by__profile_image %}
                                            <img src="{{ user_info.uploaded_by__profile_image.url }}" alt="Profile" class="rounded-circle" style="width: 40px; height: 40px;">
                                            {% endif %} {% endcomment %}

                                            <a href="{% url 'view_profile' user_info.uploaded_by %}">
                                                {% if user_info.uploaded_by__fullname %}
                                                    {{ user_info.uploaded_by__fullname|safe }}
                                                {% else %}
                                                    {{ user_info.uploaded_by.user }}
                                                {% endif %}
                                            </a>
                                        </td>
                                        <td>{{ user_info.question_count }} questions</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3">No users have uploaded questions for this course.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div>
                        <a href="{% url 'add_question' %}" class="btn btn-danger mr-2">Upload</a>
                        <span>more questions!</span>
                    </div>
                    
                </div>
            </div>
        </div>

    </div>

<script src="{% static 'javascript.js' %}"></script>




{% endblock %}


